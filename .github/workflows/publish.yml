name: Publish NPM Package
on:
    workflow_dispatch:
        inputs:
            version:
                description: New version
                required: true
                default: 'patch'
                type: choice
                options:
                    - patch
                    - minor
                    - major
    push:
        branches:
            - main

permissions:
    contents: write
    id-token: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    publish:
        if: github.actor != 'itzzjarvis'
        name: Publish new ${{ github.event_name == 'push' && 'patch' || github.event.inputs.version }} version
        runs-on: ubuntu-latest
        steps:
            - name: Checkout to 'main' Branch âœ”ï¸
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Use Node.js v24.x ğŸ‘€
              uses: actions/setup-node@v4
              with:
                  node-version: 24.x

            - name: Install dependencies using pnpm ğŸ“¦
              uses: pnpm/action-setup@v4
              with:
                  version: latest
                  run_install: true

            - name: Setup Git & GPG ğŸ”
              run: |
                  git config --global user.email "ritik.jarvis@gmail.com"
                  git config --global user.name "Jarvis"

                  mkdir -p ~/.ssh/
                  echo "${{ secrets.JARVIS_SSH_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan github.com >> ~/.ssh/known_hosts

                  git config --global gpg.format ssh
                  git config --global user.signingkey ~/.ssh/id_rsa
                  git config --global commit.gpgsign true
                  git config --global tag.gpgsign true
                  npm config set sign-git-tag true

            - name: Generate new version (Local Only) ğŸ·ï¸
              env:
                  VERSION: ${{ github.event.inputs.version || 'patch' }}
              run: |
                  TAG=$(npm version $VERSION --no-git-tag-version)
                  git tag -d $TAG 2>/dev/null || true
                  git push origin :refs/tags/$TAG 2>/dev/null || true
                  git commit -am "ğŸ¤– Jarvis published a $VERSION version"
                  git tag -s -m "ğŸ¤– Jarvis published a $VERSION version" $TAG

            - name: Building Package ğŸ—ï¸
              run: pnpm build

            - name: Generate Demo Screenshot ğŸ“¸
              run: |
                  sudo wget -q -O /usr/local/bin/ttyd https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64
                  sudo chmod +x /usr/local/bin/ttyd
                  mkdir -p /etc/apt/keyrings
                  curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
                  echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
                  sudo apt-get update && sudo apt-get install -y vhs
                  vhs demo/demo.tape

            - name: Commit Demo Screenshot ğŸ’¾
              run: git add demo/demo.png && git commit -m "ğŸ¤– Update demo screenshot" || true

            - name: Publishing Package ğŸš€
              run: npm publish --access public --provenance

            - name: Push new version to repository ğŸ‰
              run: git push --follow-tags
