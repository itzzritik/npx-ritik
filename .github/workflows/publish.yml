name: Publish NPM Package
on:
    workflow_dispatch:
        inputs:
            version:
                description: New version
                required: true
                default: 'patch'
                type: choice
                options:
                    - patch
                    - minor
                    - major
    push:
        branches:
            - main

permissions:
    contents: write
    id-token: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    publish:
        if: github.actor != 'itzzjarvis'
        name: Publish new ${{ github.event_name == 'push' && 'patch' || github.event.inputs.version }} version
        runs-on: ubuntu-latest
        steps:
            - name: Checkout to 'main' Branch âœ”ï¸
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Use Node.js v24.x ğŸ‘€
              uses: actions/setup-node@v4
              with:
                  node-version: 24.x

            - name: Install dependencies using pnpm ğŸ“¦
              uses: pnpm/action-setup@v4
              with:
                  version: latest
                  run_install: true

            - name: Set version variable ğŸ“
              run: |
                  if [ "${{ github.event_name }}" == "push" ]; then
                    echo "VERSION=patch" >> $GITHUB_ENV
                  else
                    echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
                  fi

            - name: Generate new version (Local Only) ğŸ·ï¸
              run: |
                  git config --global user.email "ritik.jarvis@gmail.com"
                  git config --global user.name "Jarvis"

                  mkdir -p ~/.ssh/
                  echo "${{ secrets.JARVIS_SSH_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan github.com >> ~/.ssh/known_hosts

                  git config --global gpg.format ssh
                  git config --global user.signingkey ~/.ssh/id_rsa
                  git config --global commit.gpgsign true
                  npm config set sign-git-tag true

                  npm version $VERSION -m "ğŸ¤– Jarvis published a $VERSION version"

            - name: Building Package ğŸ—ï¸
              run: pnpm build

            - name: Publishing Package ğŸš€
              run: npm publish --access public --provenance

            - name: Push new version to repository ğŸ‰
              run: git push --follow-tags
